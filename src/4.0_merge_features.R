#!/usr/bin/env Rscript
#
# This script merges label features generated by external scripts (e.g., random
# effect encoding, PMI, ...).
#

library(data.table)
library(feather)
library(stringr)

source("9.3_impute.R")


main = function() {
  train_paths = list.files("../data/interim/", "3_end.+train.feather",
    full.names = TRUE)
  for (p in train_paths)
    write_merge(p)
}

write_merge = function(path) {
  train = data.table(read_feather(path))

  path = str_replace(path, "train[.]feather$", "test.feather")
  test = data.table(read_feather(path))

  end = str_match(path, "3_(end..)_")[2]
  auto = list.files("../data/merge/", "correct.rds$", full.names = TRUE)
  auto = auto[startsWith(basename(auto), end)]

  # Automatically merge features with key columns.
  for (f in auto) {
    message(sprintf("Merging: %s", f))
    enc = readRDS(f)

    cols = colnames(enc)
    cols = cols[!( endsWith(cols, "ref") | cols %in% c("cluster") )]
    enc[, (cols) := lapply(.SD, as.integer), .SDcols = cols]

    setkeyv(train, cols)
    setkeyv(test, cols)
    setkeyv(enc, cols)

    train = merge(train, enc, all.x = TRUE)
    test = merge(test, enc, all.x = TRUE)
    message(sprintf("  On (%s)", paste(cols, collapse = ", ")))
  }

  # Lagged Random Effects --------------------
  setkey(train, lineID)
  setkey(test, lineID)

  tail_train_pid_ref = tail(train$pid_ref, 1)
  head_test_pid_ref = head(test$pid_ref, 1)

  train[, `:=`(
      prev_pid_ref = shift(pid_ref, 1, pid_ref[[1]])
      , next_pid_ref = shift(pid_ref, 1, head_test_pid_ref, type = "lead")
    )]
  test[, `:=`(
      prev_pid_ref = shift(pid_ref, 1, tail_train_pid_ref)
      , next_pid_ref = shift(pid_ref, 1, pid_ref[[.N]], type = "lead")
    )]

  # Merge PMI --------------------
  pmi_path = sprintf("^pmi_%s", end)
  pmi_path = list.files("../data/merge/", pmi_path, full.names = TRUE)[[1]]
  pmi = data.table(read_feather(pmi_path))

  # Set up the merge column.
  pmi_merge_key(train, fill = train$group[[1]])
  train = merge(train, pmi, by.x = "MERGE", by.y = "group", all.x = TRUE)
  train[, MERGE := NULL]
  train[is.na(pmi_group), pmi_group := 0]

  pmi_merge_key(test, fill = tail(train$group, 1))
  test = merge(test, pmi, by.x = "MERGE", by.y = "group", all.x = TRUE)
  test[, MERGE := NULL]
  test[is.na(pmi_group), pmi_group := 0]

  # Set first PMI value to 0 since the correct pair is unknown.
  train[1, pmi_group := 0]

  fill = head(test$pmi_group, 1)
  train[, next_pmi_group := shift(pmi_group, 1, fill, type = "lead")]
  test[, next_pmi_group := shift(pmi_group, 1, 0, type = "lead")]

  # Impute Missing Values --------------------
  train[, SET := "train"]
  test[, SET := "test"]
  df = rbind(train, test)
  rm(train, test); gc()

  to_fix = c(
    "content_unit_pharmForm_likelihood"
    , "manufacturer_likelihood"
    , "manu_group_likelihood"
    , "deduplicated_pid_likelihood"
    , "pid_ref"
    , "prev_pid_ref"
    , "next_pid_ref"
    , "pid_likelihood"
    , "day_adFlag_availability_campaignIndex_likelihood")
  impute_label_features(df, to_fix)

  train = df[SET == "train", ]
  test = df[SET == "test", ]
  rm(df); gc()

  train[, SET := NULL]
  test[, SET := NULL]

  # Write to ../data/processed --------------------
  prefix = file.path(dirname(dirname(path)), "processed")
  prefix = file.path(prefix, end)

  setkey(train, lineID)
  path = paste0(prefix, "_train.feather")
  write_feather(train, path)
  message(sprintf("Wrote: %s", path))

  setkey(test, lineID)
  path = paste0(prefix, "_test.feather")
  write_feather(test, path)
  message(sprintf("Wrote: %s", path))
}


pmi_merge_key = function(df, fill) {
  df[, MERGE := shift(group, 1, fill)]
  df[, MERGE := ifelse(group < MERGE
      , paste(group, MERGE, sep = "/")
      , paste(MERGE, group, sep = "/")
    )]

  invisible (NULL)
}


main()
